<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chest Cancer Classification</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <style>
    body {
      background-color: #eff2f9;
    }

    .iupload h3 {
      color: #1b2d6b;
      font-size: 30px;
      font-weight: 700;
    }

    .image-part {
      height: 300px;
      width: 300px;
      border: 1px solid #1b2d6b;
      margin: auto;
    }

    .res-part {
      border: 1px solid #dedede;
      height: 310px;
      padding: 5px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h3 class="text-center mb-4">Chest Cancer Classification</h3>

    <!-- Login Form -->
    <div class="card p-3 mb-4">
      <h5>Login</h5>
      <input id="username" class="form-control mb-2" placeholder="Username">
      <input id="password" type="password" class="form-control mb-2" placeholder="Password">
      <button class="btn btn-primary" onclick="login()">Login</button>
      <p id="loginStatus" class="mt-2 text-success"></p>
    </div>

    <div class="row">
      <!-- Image Upload and Predict Buttons -->
      <div class="col-md-6 text-center">
        <div class="image-part mb-3">
          <img id="photo" src="" style="max-width:100%; max-height:100%; display:none;">
        </div>
        <input type="file" id="fileinput" hidden>
        <button id="uload" class="btn btn-primary mr-2" disabled>Upload</button>
        <button id="send" class="btn btn-success" disabled>Predict</button>
      </div>

      <!-- Prediction Result -->
      <div class="col-md-6">
        <h5>Prediction Result</h5>
        <div class="res-part">
          <pre id="result"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script>
    let uploadedFilename = "";

    // ------------------ LOGIN ------------------
    async function login() {
      const formData = new FormData();
      formData.append("username", $("#username").val());
      formData.append("password", $("#password").val());

      const res = await fetch("http://127.0.0.1:5000/login", {
        method: "POST",
        body: formData,
      });

      if (res.ok) {
        const data = await res.json();
        $("#loginStatus").text(data.message).css("color", "green");
        $("#uload").prop("disabled", false);
        $("#send").prop("disabled", false);
      } else {
        $("#loginStatus").text("Login failed").css("color", "red");
        $("#uload").prop("disabled", true);
        $("#send").prop("disabled", true);
      }
    }

    // ------------------ UPLOAD + TRAIN ------------------
    $("#uload").click(() => $("#fileinput").trigger("click"));

    $("#fileinput").change(async function () {
      const file = this.files[0];
      const formData = new FormData();
      formData.append("file", file);

      // Step 1: Upload file
      const res = await fetch("http://127.0.0.1:5001/upload", {
        method: "POST",
        body: formData,
      });

      const data = await res.json();
      uploadedFilename = data.filename;
      $("#photo").attr("src", URL.createObjectURL(file)).show();

      // Step 2: Trigger model training
      const trainPayload = {
        data_dir: "../upload/uploads" // Adjust this if your backend expects a different path
      };

      try {
        const trainRes = await fetch("http://127.0.0.1:5003/train", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(trainPayload),
        });

        const trainData = await trainRes.json();
        console.log("Training response:", trainData);
        alert("✅ Training started: " + trainData.message);
      } catch (err) {
        console.error("Training error:", err);
        alert("⚠️ Error during training.");
      }
    });

    // ------------------ PREDICT ------------------
    $("#send").click(async function () {
      if (!uploadedFilename) {
        alert("Please upload a file first!");
        return;
      }

      const res = await fetch(`http://127.0.0.1:5002/predict?filename=${uploadedFilename}`);
      const data = await res.json();
      $("#result").text(JSON.stringify(data, null, 2));
    });
  </script>
</body>
</html>
